global
	log /dev/log	local0
	log /dev/log	local1 notice
	chroot /var/lib/haproxy
	stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
	stats timeout 30s
	user haproxy
	group haproxy
	daemon

	# Default   SSL material locations
	ca-base /etc/ssl/certs
	crt-base /etc/ssl/private

	# Default ciphers to use on SSL-enabled listening sockets.
	# For more information, see ciphers(1SSL). This list is from:
	#  https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/
	# An alternative list with additional directives can be obtained from
	#  https://mozilla.github.io/server-side-tls/ssl-config-generator/?server=haproxy
	#
	# ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS
	ssl-default-bind-options no-sslv3
    tune.ssl.default-dh-param 2048
    tune.ssl.cachesize 65530
	ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA:ECDHE-ECDSA-AES128-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:DHE-DSS-AES128-SHA256:DHE-RSA0-AES256-SHA256:DHE-DSS-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA


defaults
	log		global
	mode		http
	option	tcplog
	option	dontlognull
	    timeout	connect 5000
	    timeout	client  3600s
	    timeout	server  3600s
	    timeout	http-request    15s
	    timeout	http-keep-alive 15s
	errorfile 400 /etc/haproxy/errors/400.http
	errorfile 403 /etc/haproxy/errors/403.http
	errorfile 408 /etc/haproxy/errors/408.http
	errorfile 500 /etc/haproxy/errors/500.http
	errorfile 502 /etc/haproxy/errors/502.http
	errorfile 503 /etc/haproxy/errors/503.http
	errorfile 504 /etc/haproxy/errors/504.http

frontend monitor-in
  bind *:33301
  mode http
  option httplog
  monitor-uri /monitor

listen stats
  bind    *:9003
  mode    http
  stats   enable
  stats   hide-version
  stats   uri       /stats
  stats   refresh   30s
  stats   realm     Haproxy\ Statistics
  stats   auth      Admin:Password

  listen dev-pgsql-primary
  mode tcp
  bind *:5000
  option httpchk /primary
  http-check expect status 200
  default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
  server dev-pgsql-stupino dev-pgsql-stupino:5432 maxconn 100 check port 8008
  server dev-pgsql-vidnoe dev-pgsql-vidnoe:5432 maxconn 100 check port 8008
  server dev-pgsql-gaydary dev-pgsql-gaydary:5432 maxconn 100 check port 8008


listen dev-pgsql-standbys
  mode tcp
  balance roundrobin
  bind *:5001
  option httpchk /replica
  http-check expect status 200
  default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
  server dev-pgsql-stupino dev-pgsql-stupino:5432 maxconn 100 check port 8008
  server dev-pgsql-vidnoe dev-pgsql-vidnoe:5432 maxconn 100 check port 8008
  server dev-pgsql-gaydary dev-pgsql-gaydary:5432 maxconn 100 check port 8008


listen prod-pgsql-primary
  mode tcp
  bind *:5432
  option httpchk /primary
  http-check expect status 200
  default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
  server prod-pgsql-stupino prod-pgsql-stupino:5432 maxconn 100 check port 8008
  server prod-pgsql-vidnoe prod-pgsql-vidnoe:5432 maxconn 100 check port 8008
  server prod-pgsql-gaydary prod-pgsql-gaydary:5432 maxconn 100 check port 8008


listen prod-pgsql-standbys
  mode tcp
  balance roundrobin
  bind *:5433
  option httpchk /replica
  http-check expect status 200
  default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
  server prod-pgsql-stupino prod-pgsql-stupino:5432 maxconn 100 check port 8008
  server prod-pgsql-vidnoe prod-pgsql-vidnoe:5432 maxconn 100 check port 8008
  server prod-pgsql-gaydary prod-pgsql-gaydary:5432 maxconn 100 check port 8008

#---------------------------------------#

frontend k8s-api
  bind *:6443
  mode tcp
  option tcplog
  default_backend k8s-api

frontend minio-s3-console
  bind *:80
  mode http
  option tcplog
  default_backend minio-s3-console

frontend minio-s3-bucket
  bind *:9000
  mode tcp
  option tcplog
  default_backend minio-s3-bucket

frontend tcp-in-clichouse
    bind *:9009
    default_backend servers-clichouse

backend servers-clichouse
   server dev-clickhouse-stupino.i-sphere.local  "dev-clickhouse-stupino.i-sphere.local:9000" maxconn 5 check inter 500 resolve-prefer ipv4
   server dev-clickhouse-vidnoe.i-sphere.local   "dev-clickhouse-vidnoe.i-sphere.local:9000" maxconn 5 check inter 500 resolve-prefer ipv4
   server dev-clickhouse-gaydary.i-sphere.local  "dev-clickhouse-gaydary.i-sphere.local:9000" maxconn 5 check inter 500 resolve-prefer ipv4

backend k8s-api
  mode tcp
  balance roundrobin
  default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
  server master-01 {{ hostvars[groups['k8s_master'][0]].ansible_host }}:6443 check
  server master-02 {{ hostvars[groups['k8s_master'][1]].ansible_host }}:6443 check
  server master-03 {{ hostvars[groups['k8s_master'][2]].ansible_host }}:6443 check
  server master-04 {{ hostvars[groups['k8s_master'][3]].ansible_host }}:6443 check
  server master-05 {{ hostvars[groups['k8s_master'][4]].ansible_host }}:6443 check

backend minio-s3-console
  mode http
  balance leastconn
  server minio-node-01 {{ hostvars[groups['minio_nodes'][0]].ansible_host }}:9001 check inter 2s
  server minio-node-02 {{ hostvars[groups['minio_nodes'][1]].ansible_host }}:9001 check inter 2s
  server minio-node-03 {{ hostvars[groups['minio_nodes'][2]].ansible_host }}:9001 check inter 2s
  server minio-node-04 {{ hostvars[groups['minio_nodes'][3]].ansible_host }}:9001 check inter 2s

backend minio-s3-bucket
  mode tcp
  balance leastconn
  server minio-node-01 {{ hostvars[groups['minio_nodes'][0]].ansible_host }}:9000 check inter 5s
  server minio-node-02 {{ hostvars[groups['minio_nodes'][1]].ansible_host }}:9000 check inter 5s
  server minio-node-03 {{ hostvars[groups['minio_nodes'][2]].ansible_host }}:9000 check inter 5s
  server minio-node-04 {{ hostvars[groups['minio_nodes'][3]].ansible_host }}:9000 check inter 5s
