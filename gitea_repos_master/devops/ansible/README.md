**Требования:**

- Пользователь с правами **sudo**
- Объявленные переменные в файле **hosts**
	- `ansible_user=<USER>` 
	- `ansible_password=<PASSWORD>`

# Список плейбуков

- **[deploy_tinc](#deploy_tinc)** - установка и настройка серверов и клиентов tinc
- **[update_all_packages](#update_all_packages)** - обновление всех пакетов в системе
- **[create_user](#create_user)** - создание пользователя
- **[delete_user](#delete_user)** - удаление пользователя
- **[add_k8s_cluster_User](#add_k8s_cluster_user)** - добавление административного пользователя в кластер

##  deploy_tinc

Установка пакета и конфигурирование  **tinc**.
В зависимости от принадлежности хоста к группе **server_tinc** или **client_tinc** будет конфигурироваться соответственно как сервер или как клиент.

Доступные для использования переменные в **vars/variables.yml**:

- **route** - Маршрут. Используется при генерации скриптов:
	-  templates/tinc-up
	-  templates/tinc-down
- **tinc_dir** - Корневая директория tinc. Используется для указания пути к конфигурационным файлам
- **tinc_dir_hosts** - Директория с публичными ключами хостов. Используется для создания структуры директорий
- **tinc_private_key** - Путь до приватного ключа. Используется для проверки существования приватного ключа и запуска задания на генерацию пары ключей в случае их отсутствия
- **service_tinc_name** - Название Systemd юнита. Используется для первого запуска службы tinc, а также для рестарта службы в случае если были обнаружены новые клиенты
- **tinc_net_name** - Название сети tinc. Используется при генерации ключей в случае их отсутствия
- **template_server_host_path** - Путь до шаблона server-host.j2
- **template_tinc_conf_path** - Путь до шаблона tinc.conf.j2
- **template_tinc_up_path** - Путь до шаблона tinc-up.j2
- **template_tinc_down_path** - Путь до шаблона tinc-down.j2
- **sync_keys_local_dir** - Путь до локальной директории для обмена публичными ключами между хостами
- **servers_vpn** - Переменная, содержащая вложенную переменную, используемая при генерации в **tinc.conf** строк **ConnectTo**, куда попадают только те хосты, которые являются членами группы **server_tinc** в **hosts-файле** 

Дополнительные переменные, которые необходимо указать в inventory файле **hosts**:

- **hostname** - Имя хоста. Используется при генерации конфигурационного файла:
	-  templates/tinc.conf 
- **vpn_ip** - IP-адрес в сети VPN. Используется при генерации скриптов:
	-  templates/tinc-up
	-  templates/tinc-down
- **public_ip** - Внешний публичный адрес. Используется при генерации строки **Address** в публичном ключе. Данная переменная также является отличительной чертой хоста входящего в группу **server_tinc** от хоста в группе **client_tinc**

## update_all_packages

Обновление всех пакетов в системе.
В данный момент не требует дополнительных переменных.

## create_user

Создание новой пользовательской учетной записи.
Доступные для использования переменные в **vars/variables.yml**:

- **new_user_name** - Имя новой учётной записи
- **new_user_password** - Пароль для новой учётной записи. Указывать необходимо в виде хэша, например используя команду:
	```bash
	mkpasswd --method=sha-512
	```
- **new_user_comment** - Комментарий для понимания предназначения учётной записи. 

## delete_user

Удаление пользовательской учетной записи.
Доступные для использования переменные в **vars/variables.yml**:

- **user_name** - Имя учётной записи, которую необходимо удалить.

# Использование плейбуков

**ВАЖНО!!!** Playbook'и содержат переменную **target** в **hosts** для указания хостов/групп хостов, на которых будут запущены необходимые сценарии
```
hosts:  '{{ target }}'
```
Поэтому при запуске playbook.yml через **extra-vars** необходимо передать значения переменной **target**:
- `ansible-playbook /PATH/TO/playbook.yml --extra-var "target=all"` - запуск на всех хостах, указанных в inventory файле.
- `ansible-playbook /PATH/TO/playbook.yml --extra-var "target=<GROUP_NAME>"` - запуск на определённой группе хостов, указанной в inventory файле.
- `ansible-playbook /PATH/TO/playbook.yml --extra-var "target=<HOSTNAME>"` - запуск на отдельном хосте, указанном в inventory файле.
- `ansible-playbook /PATH/TO/playbook.yml --extra-var "target='<HOSTNAME1>, <>HOSTNAME2>'"` - запуск на нескольких отдельных хостах, указанных в inventory файле.

## Запуск определенных плейбуков

- `ansible-playbook playbooks/update_all_packages/playbook.yml --extra-var "target=all"` - запуск плейбука **update_all_packages** на всех хостах, указанных в inventory файле.
- `ansible-playbook playbooks/create_user/playbook.yml --extra-var "target=all"` - запуск плейбука **create_user** на всех хостах, указанных в inventory файле.

# Немного об Ansible extra-vars

**ВАЖНО!!!** Переменные  переданные  в  **extra-vars**  имеют  наивысший приоритет.

## Использование внешних переменных

Объявление переменной в **extra-vars** может быть осуществлено с помощью ключей:

- `-e`
- `--extra-var`
- `--extra-vars`

Можно передавать сразу несколько переменных и их значений, например:
```bash
ansible-playbook /PATH/TO/playbook.yml -e "target='<HOSTNAME1>, <>HOSTNAME2>' ansible_user=<user> ansible_password=<password>"
```

## add_k8s_cluster_User

В директории представлены два плейбука:

- `add_kubeUser.yaml`: добавление в кластер административного пользователя способом на основе openSSL сертификатов
- `k8s_module_add-user.yaml`: добавление в кластер административного пользователя способом на основе токена доступа из Service Account

На данный момент предпочтительнее использовать `k8s_module_add-user.yaml` (временно не решен вопрос с хранением сертификатов новых пользователей)

**ВНИМАНИЕ!**: оба плейбука исполняются на локальной машине администратора кластера, имеющего права "cluster-admin" в действующем конфиге.

**Доступные для использования переменные в** `group_vars/all.yml`:

**ВНИМАНИЕ!!!**: все значения переменных записываются без использования кавычек ( '_', "_")

---
    ansible_user ---------------------------- Имя пользователя, под которым будет установлено соединение
                                              с удаленным хостом  при  выполнении задачи`

    ansible_ssh_private_key_file ------------ Указание пути к файлу приватного ключа (private key) для 
                                              аутентификации Ansible при подключении к удаленному хосту

    new_user -------------------------------- Имя нового пользователя

    ВНИМАНИЕ!!!: в создаваемом имени не должно быть спец-символов и знаков нижнего регистра по типу "_"

---

    path_to_certificate_directory ----------- Полный путь до директории для сохранения сертификатов 
                                              создаваемого пользователя 
                                              (параметр для плейбука - "add_kubeUser.yaml")

    certificate_expiration_Seconds ---------- Срок действия сертификатов нового пользователя 
                                              (параметр для плейбука - "add_kubeUser.yaml". 
                                              Дефолтное значение: 315569260 # 1 год)

    server_url ------------------------------ Полная ссылка на эндпойнт API кластера 
                                              (по типу: https://....:6443)

    cluster_name ---------------------------- Имя кластера. Смотрим в действующем конфиге если не знаем.

    path_to_kubeconfig ---------------------- Полный путь до действующего конфиг-файла с правами 
                                              "cluster-admin" (параметр для плейбука - "k8s_module_add-user.yaml". 
                                              Дефолтное значение: ~/.kube/config)
---

**ВНИМАНИЕ!!!**: 
- `ansible не найдет файл конфига, если он будет находиться вне директории исполняющего плейбук пользователя`
- `под root пользователем плейбук не запустится`
- `при использвании конфига из директории, принадлежащей иному пользователю - плейбук не заработает`
- `При наличии проблем с нахождением конфига можно временно перенести конфиг файл в директорию исполнения плейбука, указав в описываемом параметре только название конфиг файла`


# Использование

Внести изменения в переменные `add_k8s_cluster_User\group_vars\all.yaml`

Либо использовать флаг аргумента --extra-var при запуске плейбука:
---
    ansible-playbook /PATH/TO/playbook.yml --extra-var "hosts=localhost \
                                                        ansible_user=ansible-user \
                                                        ansible_ssh_private_key_file=/path_to_config \
                                                        new_user=new-user \
                                                        path_to_certificate_directory=/ \
                                                        certificate_expiration_Seconds=315569260 \
                                                        server_url=https://....:6443 \
                                                        cluster_name=kubernetes \
                                                        path_to_kubeconfig=~/.kube/config"
