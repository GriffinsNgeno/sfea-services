# mongo-monitoring-service

| Название параметра                           | Значение по умолчанию                                                                                                                    | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|----------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| PROD                                         | prod                                                                                                                                     | Имя суффикса коллекций для PROD деплоя (callapp-prod)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| DEV                                          | dev                                                                                                                                      | Имя суффикса коллекций для PROD деплоя (callapp-dev)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| UNITTEST                                     | unittest                                                                                                                                 | Имя суффикса коллекций для PROD деплоя (callapp-unittest)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| TASKS                                        | ``` {"CRITICAL_MIN":"10 min","MIGRATION":"2 min","INACTIVE":"20 min","STATISTICS":"at 10:00", "UNDERPERFORMING_SUCCESS": "at 10:01"} ``` | Список задач, все доступные представлены в примере. Формат времени: X min или at XX:XX.  - Для X min задача запускается каждые X минут.  - Для at XX:XX задача запускается в данное время ежедневно.   ``` - CRITICAL_MIN - напоминание, что в коллекции на текущий момент кол-во сессий ниже минимума - MIGRATION - перелив сессий из PROD в DEV в случае достижения минимума - INACTIVE - обнаружение новых active=false сессий с момента предыдущего запуска задачи (X min) - STATISTICS - подсчет статистики кол-во сессий по коллекциям. Обычно ежедневный отчет в 10:00 - TEMP_LOCKED -  обнаружение временно заблокированных сессий (next_use) с момента предыдущего запуска задачи (X min) - UNDERPERFORMING_SUCCESS - подсчет успешности использования сессий с выводом аномальных учеток ниже порога UNDERPERFORMING_SUCCESS_DEVIATION_PERCENT``` |
| COLLECTIONS_WATCH_FOR                        | ["PROD"]                                                                                                                                 | Список коллекций, за которыми происходит наблюдение в задачах. В данном примере только у тех, у кого суффикс prod                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| COLLECTIONS_IGNORE_PATTERN                   | "^_.*"                                                                                                                                   | Игнорируемые коллекции. Формат: regex. В примере - все, начинающиеся на "_"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| NEXT_USE_ALLOWABLE_INTERVAL_DEFAULT          | 60                                                                                                                                       | Допустимое время, когда next_use поле считается активным и не временно заблокированным.  Необходим для того, чтобы исключить попадания временной блокировки сессий на несколько секунд в статистику задачи. Задается для всех коллекции, можно переопределить в NEXT_USE_ALLOWABLE_INTERVAL_PER_COLLECTION. Единицы: сек.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| NEXT_USE_ALLOWABLE_INTERVAL_PER_COLLECTION   | ```{"numbuster-prod":180,"telegram-prod":3600}```                                                                                        | Переопределение значений NEXT_USE_ALLOWABLE_INTERVAL_DEFAULT по коллекциям.  В данном случае, если у сессии telegram-prod стоит next_use=через 45мин, то она все равно будет считаться активной, т.к. допустимый интервал 1ч в примере                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| CRITICAL_MIN_PERCENT_OF_SESSIONS_TO_TRIGGER  | 20                                                                                                                                       | Процент активных сессий от общего числа. Нижний порог для триггера задачи CRITICAL_MIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| CRITICAL_MIN_REPEAT_NOTIFICATION_DELAY       | 1                                                                                                                                        | Повторное напоминание о снижении ниже порога числа активных сессий для CRITICAL_MIN. Единицы: часы                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| CRITICAL_MIN_IGNORE_COLLECTIONS              | ["telegram-prod", "numbuster-pro-prod"]                                                                                                  | Исключенные коллекции для задачи CRITICAL_MIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| INACTIVE_IGNORE_COLLECTIONS                  | ["telegram-prod"]                                                                                                                        | Исключенные коллекции для задачи INACTIVE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| MIGRATION_IGNORE_COLLECTIONS                 | ["telegram-prod"]                                                                                                                        | Исключенные коллекции для задачи MIGRATION                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| STATISTICS_IGNORE_COLLECTIONS                | []                                                                                                                                       | Исключенные коллекции для задачи STATISTICS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| UNDERPERFORMING_SUCCESS_IGNORE_COLLECTIONS   | []                                                                                                                                       | Исключенные коллекции для задачи UNDERPERFORMING_SUCCESS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| UNDERPERFORMING_SUCCESS_MIN_USE              | 100                                                                                                                                      | Минимальное количество использований сессий для подсчета статистики в задаче UNDERPERFORMING_SUCCESS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| UNDERPERFORMING_SUCCESS_DEVIATION_PERCENT    | 20                                                                                                                                       | Процент отклонения от среднего значения успешности использования в UNDERPERFORMING_SUCCESS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| TEMP_LOCKED_IGNORE_COLLECTIONS               | []                                                                                                                                       | Исключенные коллекции для задачи TEMP_LOCK                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| MIGRATION_PERCENT_SESSIONS_FROM_DEV_SESSIONS | 65                                                                                                                                       | Процент сессий от DEV коллекций, который переливается в случае если становится 0 активных сессий в PROD.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| MIGRATION_DEV_MIN_SESSIONS                   | 3                                                                                                                                        | Минимальное число сессий DEV коллекций, которых необходимо оставить при переливе.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |


