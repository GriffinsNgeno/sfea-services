# Реверс-прокси

Сервис реализует функционал реверс-прокси с дополнительными параметрами контроля за защитой трафика.

Флаги запуска:
| флаг | описание | значение по умолчанию |
|---|---|---|
| `-config-file` | файл конфигурации, допускается регулярное выражение | `config/*.yaml` |
| `-https.host` | IP адрес HTTPS сервера | `127.0.0.1` |
| `-https.port` | Порт HTTPS сервера | `443` |
| `-https.cert-file` | Сертификат HTTPS сервера, требуется для установленного режима **LOCAL** | `ssl/server.crt` |
| `-https.key-file` | Ключ для шифрования соединения, требуется для установленного режима **LOCAL** | `ssl/server.key` |
| `-https.letsencrypt-cache-dir` | Директорая для хранения ключей LetsEncrypt, требуется только если режим `-local` не установлен | `ssl/letsencrypt` |
| `-http.host` | IP адрес HTTP сервера | `127.0.0.1` |
| `-http.port` | Порт HTTP сервера | `80` |
| `-server-name` | Имя сервера, используется только для ответов сервера в заголовке `Server` | `SpheriX/1.23.4` |
| `-geoip-path` | Директория с файлами базы данных [GeoIP2](https://github.com/P3TERX/GeoLite.mmdb) | `share/GeoIP` |
| `-local` | Режим **LOCAL** осуществляет запуск сервера с самоподписанными сертификатами в случаях, когда доступ к серверу отсутствует для LetsEncrypt | `false` |

## Файл конфигурации

Файлы конфигурации должны быть написаны в формате `yaml` по одному ресурсу в каждом файле.

Пример файла:

```yaml
routes:                     # ресурс маршрутизации
  - server:                 # сервер ресурса
      host: yandex.ru       # домен
      port: 80              # порт домена
    redirect:               # указание этого ключа означает, что необходимо осуществлять безусловный редирект
      scheme: https         # меняем схему запроса на https
      port: 443             # меняем целевой порт запроса  --> (A)
  - server:
      host: yandex.ru        
      port: 443             # (A) --> приходим редиректом сюда
    origin:                 # этот ключ говорит о параметрах непосредственно реверс-прокси
      scheme: http          # снова меняем схему с https на http
      host: 0.0.0.0         # проксируем запрос на указанный хост
      port: 9000            # и порт соответственно
```

В общем виде данная конфигурация будет выглядеть следующим образом:

1. При обращении к домену http://yandex.ru будет осуществлен редирект на домен https://yandex.ru:443
2. При обращении к домену https://yandex.ru:443 будет осуществлено проксирование запроса на http://0.0.0.0:9000


## Логгирование запросов 

Лог реверс прокси осуществляется в STDOUT поток в стандартном NGINX формате:

```bash
2024/02/12 11:43:25 INFO 127.0.0.1:56828 - - [12/Feb/2024:11:43:24 +0300] "GET /wp-admin/ HTTP/1.1" 200 10252 "" "curl/8.4.0" "ru" "89c23ef504c3cc9ccd6580643494edae"
```

Где дополнительные два поля в конце - регион по базе GeoIP2 и JA3 соединения.
