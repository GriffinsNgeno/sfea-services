---
title: samsung-auth-api
description: 
published: true
date: 2024-05-13T08:30:38.756Z
tags: 
editor: markdown
dateCreated: 2024-05-13T08:26:27.752Z
---

# samsung-auth-api

Поиск учетной записи пользователя по e-mail.

### Краткое описание приложения

#### Особенности работы сайта `account.samsung.com`
1. При загрузке главной страницы, сначала загружается страница `https://account.samsung.com/membership/auth/sign-in` затем происходит переадресация на `https://account.samsung.com/accounts/v1/MBR/signInGate`.  
2. До ввода данные в поле поиска, кнопка поиска не активна.
3. Сайт имеет защиту от ботов. Использует стороннее решение DataDome https://docs.datadome.co/docs/javascript-tag, это Java Script, который определяет режим `Headless`, использование `Selenium` и его модификаций.
4. Сайт очень подозрительно относится к браузеру `Chrome` и при авторизации на сайте с использованием данного браузера требует решить капчу (слайдер, совместить пазл). Даже при использовании браузера локально, не под управлением `Selenium`. При попытке авторизоваться на сайте используя `Chrome` под управлением `Selenium`, сайт определяет использование бота и блокирует доступ. При этом сайт безоговорочно доверяет браузеру `FireFox` и не предлагает решить капчу при попытке авторизоваться, позволяет работать под управлением `Selenium`.
5. Java Script код сайта ведет обмен данными с `www.recaptcha.net` и `www.google.com` причем даже после отправки данных формы с информацией о пользователе.

#### Описание приложения
Получение данных с сайта выполняется с использованием двух отдельных приложений:
- samsung-session-register
- samsung-auth-api
##### samsung-session-register
- Использует браузер `FireFox` под управлением `Selenium` для получение параметров запроса отправки формы с данными пользователя (далее - Сессия).
- Так как после отправки формы на сайт `samsung`, Java Script код сайта `samsung` ведет обмен с `www.recaptcha.net` и `www.google.com`, последним запросом браузера не является отправка формы. Библиотека `Selenium` позволяет получить только данные последнего запроса, потому в приложении использована ее модификация `selenium-wire` (https://pypi.org/project/selenium-wire/) которая хранит историю всех запросов и позволяет получить к ним доступ.
- Приложении `samsung-session-register` выполняет следующие задачи:
	- автоматически генерирует сессии по расписанию с заданным интервалом (T) и заданным количеством (N);
	- если сессий достаточное количество (N), то обновляет заблокированные сессии и уходить в сон на время Т;
	- если сессий менее заданного количества N, то обновляет заблокированные сессии и добавляет новые до нужного количества, уходить в сон на время Т;
	- если сессий более заданного количества N, то удаляет избыточные заблокированные и обновляет оставшиеся заблокированные сессии, уходить в сон на время Т;
	- сессии сохраняет в MongoDB.
###### Настройка samsung-session-register
Конфигурационный файл `.env`:
- `MODE=dev` - режим работы приложения.
- `PROXY_URL=` - URL-адрес для получению прокси.
- `MONGO_URL=` - URL-адрес для подключения к MongoDB.
- `MONGO_DB=` - база данных в MongoDB.
- `MONGO_COLLECTION=` - коллекция в MongoDB.
- `SENTRY_URL=` - URL-адрес для подключения к Glitchtip.

Класс `ConfigApp`
- `START_URL=` - URL-адрес начальной страницы для получения сессии.
- `SESSION_URL=` - URL-адрес по которому определяется нужная сессия в истории запросов браузера.
- `MULTIPLE_WAIT = 3` - количество попыток загрузить стартовую страницу.
- `TIME_SESSION_BECOMES_OLD = {"minutes": 10}` - время, по истечении которого сессия считается старой

##### samsung-auth-api
- Использует `FastAPI` для взаимодействия с пользователем.
- Использует библиотеку `requests-logic`, для работы с сетью. Внутри используется  `requests` так как с `aiohttp` сайт `samsung` не работает и падает с 500 ошибкой. Для обеспечения асинхронности использован декоратор `sync_to_async` библиотеки `asgiref` (https://pypi.org/project/asgiref/).
- Приложении `samsung-auth-api` выполняет  следующие задачи:
	- получает из MongoDB сгенерированные `samsung-session-register` сессии;
	- с применением полученной сессии получать информацию с сайта Samsung о наличии аккаунта пользователя;
	- обновлять данные по используемой сессии: увеличивает счетчик использования  сессии, блокирует нерабочие сессии, обновляет время последнего использования сессии.
###### Настройка samsung-auth-api
Конфигурационный файл `.env`:
- `MODE=dev` - режим работы приложения.
- `PROXY_URL=` - URL-адрес для получению прокси.
- `MONGO_URL=` - URL-адрес для подключения к MongoDB.
- `MONGO_DB=` - база данных в MongoDB.
- `MONGO_COLLECTION=` - коллекция в MongoDB.
- `SENTRY_URL=` - URL-адрес для подключения к Glitchtip.

Класс `ConfigApp`
- `BASE_URL=` - URL-адрес для отправки данных пользователя на сайт `samsung` для получения информации о наличии аккаунта.
- `TASK_TIMEOUT=` - таймаут на обработку поступившей задачи.

Файл `logging.yaml`  содержит конфигурацию логера для `uvicorn`.


##### Обоснование разделения приложения на два
- Время получения одной сессии приложением `samsung-session-register` в среднем занимает порядка 12 секунд.
- Время жизни сессии 10 минут, если ее не в течении данного времени не использовать. Если использовать, то время жизни продлится на 10 минут от последнего использования.
- Сессия за время ее жизни может быть использована не более 9 раз (10 раз, но один раз тратится на ее получение).
- Время получения данных приложением `samsung-auth-api` с использованием сохраненной сессии зависит от скорости интернет соединения и занимает порядка 0.1 - 0.5 секунд.
- Таким образом разделение приложения на два позволило в несколько раз сократить время поиска и выполнять это с меньшими затратами ресурсов.
