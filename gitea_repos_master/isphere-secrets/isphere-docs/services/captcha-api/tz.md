---
title: Техническое задание
description: 
published: true
date: 2023-10-04T18:15:44.929Z
tags: 
editor: markdown
dateCreated: 2023-10-04T18:09:33.995Z
---

# Техническое задание сервиса капч

Необходимо реализовать сервис решения число буквенных капч на основе собственных НС и внешнего API. 

**Репозиторий:** https://git.i-sphere.ru/isphere-services/captcha-image-api


## Описание сервиса

Сервис представляет собой backend сервер на FastAPI, имеющий подключение к S3 хранилищу. В БД хранится информация о НС в формате onnx и метаинформация. Также backend имеет доступ к внешним сервисам, которые способны решить капчу. Сервис имеет набор HTTP REST API запросов для решения капч переданных в теле запроса, используя либо собственные НС, либо внешенее API в зависимости от стратегии решения. В будущем сервис будет накапливать статистику решения капчи и использовать ее для выбора лучшего метода, кешировать решенные капчи. 

## Основные требования

- Использование FastAPI, S3, (далее возможно PostgreSQL)
- Завернуть приложение в Docker 
- Наличие логгирования в системе
- Гарантированный ответ (в том числе неуспешность) в течении указанного времени
- Использование классов Python
- Использование паттернов проектирования (singleton для подключения в БД)
- Использование async/await
- Задание основных параметров и констант через ENV (python-dotenv)
- Масштабирование кода
- Документирование API с использованием Swagger, docstring и архитектурной документации
- Наличие unittest

### Этап 1. Разработка сервиса на FastAPI, работающий только с собственными НС.

Существует 2 основных провайдера решения капчи: собственная НС и внешнее API (Этап 2). 
Собственная НС задается в БД, динамически меняется список НС. 

НС сохранена в onnx формате. Метаданные НС имееют примерно следующий вид. 
```json
[
   {
      "network_params":{
         "answer_lenght":"6",
         "characters":"123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",
         "img_heigh":"40",
         "img_width":"120"
      },
      "networkname":"getcontact"
   }
]
```
За доступом к НС обращаться к автору ТЗ. 

Сервис на FastAPI должен в момент запуска выгружать НС из S3 хранилища, инициализировать их запуск. Альтернативным решением является динамический мониторинг состояния S3 на предмет изменения списка НС. Данное требование предъявляется с целью упрощения деплоя приложения, хотим просто добавить в БД новую НС, (возможно перезапустить pod приложения) и сервис готов решать капчи нового вида.

API должно иметь возможность принять входное изображение по ссылке или в теле запроса и отдать: решение на капчу, точность распознавания, время решения. Должна быть предусмотрена возможность задания максимального времени на решение капчи в теле запроса и требуемой точности. 

Требуемые дополнительные методы REST API:

- `GET /status` - получение в формате json состояния сервера (ok, pending_nn, error)
- `GET /providers` - получение списка методов решения капч (список НС + в будущем внешенее API, признак отличия должен быть также указан)

Задачи:
- Спроектировать структуру БД
- Описать список запросов REST с примерами
- Научиться запускать НС
- Загружать динамически НС
- Разработка сервера FastAPI
- Деплой приложения

### Этап 2. Поддержка внешнего API

Добавляются методы распознавания капчи только на основе внешнего API (без стратегий, этап 3). Список внешенего API статичен.

**Сервисы внешнего API**:
- https://rucaptcha.com/
- https://capmonster.cloud/ru/
- https://anti-captcha.com/

Сервисы внешнего API платные, поэтому данные сервисы нежелательны для частого использования. У большинства сервисов существуют библиотеки на python для работы с ними, рекомендуется использовать их. Для доступа к данным сервисам необходимо использовать токены, которые будут заданы в env (запросить у автора). 

Каждое внешнее API имеет свой набор дополнительных параметров, которые можно указать при передачи капчи (например, какая предположительная длина капчи, какие символы в ней и т.п). В идеале нужно написать универсальный адаптер, который доп. данные, переданные с капчей в наше API будут преобразовать в формат требуемый внешнем API и пробрасывать их.

Дополнительно нужно реализовать метод API, который будет принимать успешность решения капчи. Для каждой задачи во внешнем API присваивается id (смотри докуменацию по API), нужно сделать метод, который будет принимать id задачи, наименование источника API, статус (успешно, ошибка) и пробрасывать во внешнее API для отчетности. Это необходимо например для снижения стоимости решения - неуспешные капчи стоят дешевле. (Пример - https://rucaptcha.com/api-rucaptcha, ключевое слово - reportbad)

Задачи:
- Описать список запросов REST с примерами
- Написать классы работы с внешнем API
- Доработка сервера FastAPI
- Деплой приложения

### Этап 3. Поддержка стратегий решений капчи. 

Возникают ситуации, когда нужно решить капчу 100% или очень быстро, тогда необходимо слать капчу в разные источники. Должна быть возомжность решения капчи по стратегии, стратегии описываются в конфигурационном файле и по имени в query params применяются для входной капчи

Задачи:
- Еще на согласовании

### Этап 4. Кеширование. 

Для сбора датасетов нужно сохранять все изображения + ответы на капчи

Задачи:
- Еще на согласовании


### Этап 5. Статистика. 

Необходимо накапливать статистику успешности решения капчи за определенное время по каждой НС + внешнему API и в зависимости от успешности перенаправлять капчи в более успешные провайдеры. 

Задачи:
- Еще на согласовании

### Этап ?. Метрики Prometheus

- `GET /metrics`

Задачи:
- Еще на согласовании


